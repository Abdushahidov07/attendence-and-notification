{% extends 'base.html' %}

{% block title %}Список студентов{% endblock %}

{% block extra_css %}
<style>
    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
    .status-badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.85rem;
    }
    .status-present {
        background-color: #28a745;
        color: white;
    }
    .status-late {
        background-color: #ffc107;
        color: #212529;
    }
    .status-absent {
        background-color: #dc3545;
        color: white;
    }
    .btn-group .btn {
        margin: 0 2px;
    }
    .table td {
        vertical-align: middle;
    }
    
    /* Стили для поля поиска */
    .form-control {
        color: #212529 !important;
        background-color: #fff !important;
    }
    .form-control::placeholder {
        color: #6c757d !important;
        opacity: 0.8;
    }
    .form-control:focus {
        color: #212529 !important;
        background-color: #fff !important;
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-3" data-aos="fade-right">
                <i class="fas fa-users text-primary me-2"></i>
                Список студентов
            </h2>
        </div>
        <div class="col-md-4">
            <div class="d-flex justify-content-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal" data-aos="fade-left">
                    <i class="fas fa-plus me-1"></i>
                    Добавить студента
                </button>
            </div>
        </div>
    </div>

    <!-- Filters and Table -->
    <div class="row">
        <!-- Filters -->
        <div class="col-md-3 mb-4" data-aos="fade-right">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-filter text-primary me-2"></i>
                        Фильтры
                    </h5>
                    <form method="get">
                        <div class="mb-3">
                            <label class="form-label">Поиск</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" name="search" class="form-control" 
                                       placeholder="Имя или фамилия..."
                                       value="{{ search_query }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Курс</label>
                            <select name="class" class="form-select">
                                <option value="">Все курсы</option>
                                {% for class in classes %}
                                <option value="{{ class.id }}" {% if selected_class == class.id %}selected{% endif %}>
                                    {{ class.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Учитель</label>
                            <select name="teacher" class="form-select">
                                <option value="">Все учителя</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.id }}" {% if selected_teacher == teacher.id %}selected{% endif %}>
                                    {{ teacher.f_name }} {{ teacher.l_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i>
                            Применить
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Table -->
        <div class="col-md-9" data-aos="fade-left">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Фото</th>
                                    <th>Имя</th>
                                    <th>Telegram</th>
                                    <th>Курсы</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr>
                                    <td>
                                        <img src="https://ui-avatars.com/api/?name={{ student.f_name }}+{{ student.l_name }}&background=4e73df&color=fff" 
                                             class="avatar" alt="{{ student.f_name }}">
                                    </td>
                                    <td>
                                        <div class="fw-bold">{{ student.f_name }} {{ student.l_name }}</div>
                                        <small class="text-muted">ID: {{ student.telegram_id|default:"Не указан" }}</small>
                                    </td>
                                    <td>
                                        {% if student.username %}
                                        <a href="https://t.me/{{ student.username }}" target="_blank" 
                                           class="text-decoration-none">
                                            @{{ student.username }}
                                        </a>
                                        {% else %}
                                        <span class="text-muted">Не указан</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% for class in student.class_id.all %}
                                        <span class="badge bg-primary">{{ class.name }}</span>
                                        {% empty %}
                                        <span class="text-muted">Нет курсов</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% if student.attendens.last %}
                                            {% if student.attendens.last.omad %}
                                                <span class="status-badge status-present">
                                                    <i class="fas fa-check me-1"></i>
                                                    Присутствует
                                                </span>
                                            {% elif student.attendens.last.dercard %}
                                                <span class="status-badge status-late">
                                                    <i class="fas fa-clock me-1"></i>
                                                    Опаздывает
                                                </span>
                                            {% else %}
                                                <span class="status-badge status-absent">
                                                    <i class="fas fa-times me-1"></i>
                                                    Отсутствует
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">Нет данных</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-update btn-icon" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editStudentModal"
                                            data-student-id="{{ student.id }}"
                                            data-student-fname="{{ student.f_name }}"
                                            data-student-lname="{{ student.l_name }}"
                                            title="Изменить">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-delete btn-icon" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#deleteStudentModal"
                                            data-student-id="{{ student.id }}"
                                            data-student-name="{{ student.f_name }} {{ student.l_name }}"
                                            title="Удалить">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-search fa-2x mb-3"></i>
                                            <p>Студенты не найдены</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна -->
{% include "modals/student_add_modal.html" %}
{% include "modals/student_edit_modal.html" %}

<!-- Модальное окно для удаления -->
<div class="modal fade" id="deleteStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trash-alt text-danger me-2"></i>
                    Подтверждение удаления
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="deleteStudentForm" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить студента <strong id="deleteStudentName"></strong>?</p>
                    <p class="text-danger"><small>Это действие нельзя будет отменить.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript для модальных окон -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработка модального окна редактирования
    const editModal = document.getElementById('editStudentModal');
    editModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const studentId = button.getAttribute('data-student-id');
        const fName = button.getAttribute('data-student-fname');
        const lName = button.getAttribute('data-student-lname');
        
        const form = editModal.querySelector('#editStudentForm');
        form.action = `/student/${studentId}/edit/`;
        editModal.querySelector('#editStudentFName').value = fName;
        editModal.querySelector('#editStudentLName').value = lName;
    });

    // Обработка модального окна удаления
    const deleteModal = document.getElementById('deleteStudentModal');
    deleteModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const studentId = button.getAttribute('data-student-id');
        const studentName = button.getAttribute('data-student-name');
        
        const form = deleteModal.querySelector('#deleteStudentForm');
        form.action = `/student/${studentId}/delete/`;
        deleteModal.querySelector('#deleteStudentName').textContent = studentName;
    });
});
</script>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Редактирование студента
    var editStudentModal = document.getElementById('editStudentModal')
    editStudentModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget
        var studentId = button.getAttribute('data-student-id')
        var studentFName = button.getAttribute('data-student-fname')
        var studentLName = button.getAttribute('data-student-lname')
        
        var form = editStudentModal.querySelector('#editStudentForm')
        form.action = '/student/' + studentId + '/edit/'
        form.querySelector('#editStudentFName').value = studentFName
        form.querySelector('#editStudentLName').value = studentLName
    })

    // Удаление студента
    var deleteStudentModal = document.getElementById('deleteStudentModal')
    deleteStudentModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget
        var studentId = button.getAttribute('data-student-id')
        var studentName = button.getAttribute('data-student-name')
        
        var form = deleteStudentModal.querySelector('#deleteStudentForm')
        form.action = '/student/' + studentId + '/delete/'
        deleteStudentModal.querySelector('#deleteStudentName').textContent = studentName
    })

    // Инициализация тултипов
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
})
</script>
{% endblock %}
